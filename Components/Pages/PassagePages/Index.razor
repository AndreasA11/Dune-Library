@page "/passages"
@using Microsoft.CodeAnalysis.CSharp.Syntax
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using DuneLibrary.Models
@using DuneLibrary.Data
@implements IAsyncDisposable
@inject IDbContextFactory<DuneLibrary.Data.DuneLibraryContext> DbFactory

<PageTitle>Index</PageTitle>

<h1>Index</h1>

<div>
    <form action="/passages" data-enhance data-permanent>
        <select name = "BookNameDropdown">    
            <option value=""></option>
            <option value="Dune">Dune</option>
            <option value="Dune Messiah">Dune Messiah</option>
            <option value="Children of Dune">Children of Dune</option>
            <option value="God Emperor of Dune">God Emperor of Dune</option>
            <option value="Heretics of Dune">Heretics of Dune</option>
            <option value="Chapterhouse: Dune">Chapterhouse: Dune</option>
        </select>
        <input type="search" name="AuthorNameSearch" />
        <input type="submit"/>
    </form>
</div>

<p>
    <a href="passages/create">Create New</a>
</p>



<QuickGrid Id="QG1" Class="table" Items="setFilteredPassage()">
    <PropertyColumn Property="passage => passage.Passages" />
    <PropertyColumn Property="passage => passage.Book" />
    <PropertyColumn Property="passage => passage.ChapterNum" Title ="Chapter #"/>
    <PropertyColumn Property="passage => passage.Author" />
    <PropertyColumn Property="passage => passage.Series" />
    <PropertyColumn Property="passage => passage.Organization" />
    <PropertyColumn Property="passage => passage.WordCount" Title ="Word Count"/>
    <PropertyColumn Property="passage => passage.AverageRating" Title ="Average Rating"/>

    <TemplateColumn Context="passage">
        <a href="@($"passages/edit?id={passage.Id}")">Edit</a> |
        <a href="@($"passages/details?id={passage.Id}")">Details</a> |
        <a href="@($"passages/delete?id={passage.Id}")">Delete</a>
    </TemplateColumn>
</QuickGrid>

@code {
    private DuneLibraryContext context = default!;
    [SupplyParameterFromQuery]
    //private string? BookNameFilter { get; set; }
    private string? AuthorNameSearch { get; set; }
    
    [SupplyParameterFromQuery]
    private string? BookNameDropdown { get; set; }
    
    private IQueryable<Passage> FilteredPassages =>
        context.Passage.Where(p => (p.Author.Contains(AuthorNameSearch ?? string.Empty) && p.Book.Equals(BookNameDropdown ?? string.Empty)));
    
    private IQueryable<Passage> FilteredPassages2 =>
        context.Passage.Where(p => (p.Author.Contains(AuthorNameSearch ?? string.Empty) && p.Book.Contains(BookNameDropdown ?? string.Empty)));
    
    //Changes what the filtering of the passage is based on what BookNameDropdown is
    //if BookNameDropdown is nothing, allow for author based searching to work regardless of book name
    //else need both book name and author name of passage to be correct
    private IQueryable<Passage> setFilteredPassage() {
        if(BookNameDropdown == "") {
            IQueryable<Passage> FilteredPassages1 =   
                context.Passage.Where(p => (p.Author.Contains(AuthorNameSearch ?? string.Empty) && p.Book.Contains(BookNameDropdown ?? string.Empty))); 
            return FilteredPassages1;
        } else {
            IQueryable<Passage> FilteredPassages2 =
                context.Passage.Where(p => (p.Author.Contains(AuthorNameSearch ?? string.Empty) && p.Book.Equals(BookNameDropdown ?? string.Empty)));
            return FilteredPassages2;
        }
    }
    protected override void OnInitialized()
    {
        context = DbFactory.CreateDbContext();
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}
